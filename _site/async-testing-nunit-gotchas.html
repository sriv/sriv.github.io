<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta content="en-au" http-equiv="Content-Language" />
		<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
		<link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Blog Feed" />
		<link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Blog Feed" />

		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
		<title>Async testing gotchas with NUnit</title>
		<link rel="stylesheet" type="text/css" href="/css/style.css" />
		<link rel="shortcut icon" href="/img/favicon.ico" />
	</head>
	<body>
		<div id="container">
			<div id="side">
				<div id="hometext"><a href="/" >sriv.github.com</a></div>
				<div class="section">
					<ul>
						<li><a href="/about.html">about</a></li>
						<li><a href="/rss.xml"><img src="/img/25.png" /> feed</a></li>
					</ul>
				</div>
			</div>
			<div id="content">
				<div class="entry-container">
	<div class='entry'>
		<h1> Async testing gotchas with NUnit </h1>
		<span class="postdate">
			
				<li><a href="/tag/n">n</a></li>
			
				<li><a href="/tag/u">u</a></li>
			
				<li><a href="/tag/n">n</a></li>
			
				<li><a href="/tag/i">i</a></li>
			
				<li><a href="/tag/t">t</a></li>
			
				<li><a href="/tag/ "> </a></li>
			
				<li><a href="/tag/a">a</a></li>
			
				<li><a href="/tag/s">s</a></li>
			
				<li><a href="/tag/y">y</a></li>
			
				<li><a href="/tag/n">n</a></li>
			
				<li><a href="/tag/c">c</a></li>
			
				<li><a href="/tag/ "> </a></li>
			
				<li><a href="/tag/t">t</a></li>
			
				<li><a href="/tag/e">e</a></li>
			
				<li><a href="/tag/s">s</a></li>
			
				<li><a href="/tag/t">t</a></li>
			
				<li><a href="/tag/i">i</a></li>
			
				<li><a href="/tag/n">n</a></li>
			
				<li><a href="/tag/g">g</a></li>
			
		</span>
		<p>NUnit released version 2.6.2 with support for testing asynchronous methods. I decided to give it a shot.</p>
<p>And my trial was to write some tests for an async WebApi controller. Lets say we have a controller called <code>UserController</code>. And I want to add an action called <code>Get</code> which looks like this - </p>
<pre><code>public Task&lt;User&gt; Get(string userId)
{
        if (string.IsNullOrEmpty(userId))
        {
            throw new ArgumentException(&quot;No username specified.&quot;);
        }

        return Task.Factory.StartNew(
            () =&gt;
                {
                    var user = userRepository.GetById(userId);
                    if (user != null)
                    {
                        return user;
                    }

                    throw new HttpResponseException(Request.CreateErrorResponse(
                        HttpStatusCode.NotFound, string.Format(&quot;{0} - username does not exist&quot;, userId)));
                });
}
</code></pre>

<p>Great, so we have an action that is asynchronous. Now there are two kinds of tests that we would have to write, one for the happy path, and another to ensure that the exception is thrown with the right properties set.</p>
<p>Here's how I ended up writing the happy path test -</p>
<pre><code>[Test]
public async void ShouldGetUserDetails()
{
    var mockUserRepository = new Mock&lt;IUserRepository&gt;();
    mockUserRepository.Setup(x =&gt; x.GetByUserName(It.IsAny&lt;string&gt;())).Returns(new User { UserName = &quot;foo&quot; });
    var userController = new UserController(mockUserRepository.Object);

    var user = await userController.Get(&quot;foo&quot;);

    Assert.IsNotNull(user);
    Assert.That(user.UserName, Is.EqualTo(&quot;foo&quot;));
}
</code></pre>

<p>All good! The test passes. The only difference here is the use of <code>async</code> and <code>await</code> keywords in the test.</p>
<p>Now comes the fun part, I tried writing tests to assert on the exception part. It took some effort and <a href="http://stackoverflow.com/questions/15634542/nunit-async-test-exception-assertion">guidance on StackOverflow</a> to figure out a way.</p>
<p>The question also lists out various scenarios where my attempts to write a test to assert the exception thrown wasn't working as expected. There are explanations in the accepted answer.</p>
<p>Following the hint from the answer, I ended up writing a helper method that will help assert the exception thrown, along with specific properties to verify. Here is how I did it -</p>
<pre><code>public static class AssertEx
{
    public static async Task ThrowsAsync&lt;TException&gt;(Func&lt;Task&gt; func) where TException : class
    {
        await ThrowsAsync&lt;TException&gt;(func, exception =&gt; { });
    } 

    public static async Task ThrowsAsync&lt;TException&gt;(Func&lt;Task&gt; func, Action&lt;TException&gt; action) where TException : class
    {
        var exception = default(TException);
        var expected = typeof(TException);
        Type actual = null;
        try
        {
            await func();
        }
        catch (Exception e)
        {
            exception = e as TException;
            actual = e.GetType();
        }

        Assert.AreEqual(expected, actual);
        action(exception);
    }
}
</code></pre>

<p>And this is how I use it</p>
<pre><code>[Test]
public async void ShouldThrow404WhenNotFound()
{
    var mockUserRepository = new Mock&lt;IUserRepository&gt;();
    mockUserRepository.Setup(x =&gt; x.GetByUserName(It.IsAny&lt;string&gt;())).Returns(default(User));
    var userController = new UserController(mockUserRepository.Object) { Request = new HttpRequestMessage() };

    Action&lt;HttpResponseException&gt; asserts = exception =&gt; Assert.That(exception.Response.StatusCode, Is.EqualTo(HttpStatusCode.NotFound));
    await AssertEx.ThrowsAsync(() =&gt; userController.Get(&quot;foo&quot;), asserts);
}
</code></pre>

<p>Note that the asserts are now wrapped into an action and passed to <code>AssertEx.ThrowsAsync</code>.</p>

	</div>
</div>
<div id="page-navigation"> 
	<div class="left">  </div> 
	<div class="right">  </div> 
	<div class="clear">&nbsp;</div>
</div> 



<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'sriv'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

			</div>

		</div>
		<a title="Web Analytics" href="http://getclicky.com/100552509"><img alt="Web Analytics" src="//static.getclicky.com/media/links/badge.gif" border="0" /></a>
		<script type="text/javascript">
		var clicky_site_ids = clicky_site_ids || [];
		clicky_site_ids.push(100552509);
		(function() {
		  var s = document.createElement('script');
		  s.type = 'text/javascript';
		  s.async = true;
		  s.src = '//static.getclicky.com/js';
		  ( document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0] ).appendChild( s );
		})();
		</script>
		<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/100552509ns.gif" /></p></noscript>		
	</body>
</html>